우리 ERP(Next.js 16 App Router, React 19, TS5, Mantine v8, Supabase DB/Auth/Storage, Vercel 배포)에 “공과금 고지서 자동등록” 기능을 끝까지 구현해라. OCR은 네이버 CLOVA OCR(Template 우선 + General 폴백), LLM 구조화는 OpenRouter API로 google/gemini-2.5-flash 모델을 호출해 수행한다. 가장 중요한 요구사항은 촬영/업로드 이미지에서 고지서(문서) 영역만 자동 검출 → 크롭 + 원근보정(스캔본처럼 평탄화) + 전처리(2트랙)로 인식률을 올린 뒤 OCR 하는 파이프라인이다. 애매하면 자동확정 금지, 반드시 검수(NEEDS_REVIEW)로 보낸다.

0) OpenRouter 호출 규칙(반드시 준수)

OpenRouter는 OpenAI 호환 Chat Completions 엔드포인트를 사용한다: POST https://openrouter.ai/api/v1/chat/completions 
OpenRouter

인증은 Authorization: Bearer <OPENROUTER_API_KEY> 헤더로 한다. 
OpenRouter

선택 헤더로 HTTP-Referer, X-Title을 설정해도 된다(권장/선택). 
OpenRouter
+1

JSON 스키마 강제 출력은 OpenRouter Structured Outputs 방식으로 response_format.type="json_schema" 를 사용한다. 
OpenRouter

모델은 OpenRouter 모델 ID google/gemini-2.5-flash 를 사용한다. 
OpenRouter

1) 사용자 흐름(필수)

/utility-bills : 목록(상태/월/현장 필터), “업로드” 버튼

/utility-bills/new : 업로드(파일 선택/촬영 업로드), 업로드 후 처리 상태 표시

/utility-bills/[id] : 상세/검수(좌: processed 스캔본+원본 토글 / 우: 필드 폼+evidence / 버튼: 확정·재처리·폐기)

상태 전이: PROCESSING → (CONFIRMED 또는 NEEDS_REVIEW) → (REJECTED 가능)

2) Supabase DB 스키마(필수)

utility_bills 테이블 생성(마이그레이션+RLS). 컬럼:

id(uuid pk), company_id(uuid), site_id(uuid nullable)

vendor_name(text), bill_type(text: ELECTRICITY/WATER/GAS/TELECOM/TAX/ETC)

amount_due(bigint), due_date(date)

billing_period_start/end(date nullable)

customer_no(text nullable), payment_account(text nullable)

status(text: PROCESSING/NEEDS_REVIEW/CONFIRMED/REJECTED)

confidence(numeric 0~1)

ocr_mode(text: TEMPLATE/GENERAL)

template_id(text nullable)

raw_ocr_text(text nullable)

extracted_json(jsonb)

file_url(text), processed_file_url(text)

processing_stage(text: PREPROCESS/TEMPLATE_OCR/GENERAL_OCR/GEMINI/VALIDATE/DONE)

last_error_code/text, last_error_message/text

created_at, updated_at
RLS는 기존 ERP 패턴대로 company_id 기준 접근 제어. 서버(서비스 롤)만 처리 파이프라인 업데이트 가능.

3) Storage(필수)

bucket utility-bills

{companyId}/{billId}/original/*

{companyId}/{billId}/processed/scan.png

{companyId}/{billId}/processed/trackA.png

{companyId}/{billId}/processed/trackB.png

4) API 라우트(필수)

POST /api/utility-bills 업로드→Storage 저장→DB 생성(PROCESSING)→백그라운드 트리거→billId

GET /api/utility-bills/[id]

POST /api/utility-bills/[id]/retry

POST /api/utility-bills/[id]/confirm

POST /api/utility-bills/[id]/reject

5) 백그라운드 처리(필수, Vercel 제약 고려)

긴 작업(전처리/OCR/LLM)은 동기 금지. 다음 중 1개로 구현:

Supabase Edge Function process-utility-bill (권장)

Vercel Cron으로 PROCESSING 레코드 처리
단계별 stage 업데이트/에러 저장/재처리 가능 필수.

6) 전처리(핵심, 반드시)

EXIF 회전 보정

문서 자동 검출(윤곽선 기반) → 4꼭짓점 → 원근보정(perspective transform) → scan.png

Track A(컬러 유지, 템플릿 OCR 유리): 가벼운 대비 개선 + 노이즈 완화

Track B(글자 강조, 일반 OCR 유리): 그레이/그림자 완화/적응형 이진화(과하지 않게)

문서 검출 실패 시: 자동확정 금지, NEEDS_REVIEW로 보내고 evidence에 실패 사유 남김(추후 수동 크롭 확장 가능하도록 분리)

7) CLOVA OCR 하이브리드(필수)

Template OCR(Track A) 우선

실패/필드 부족/텍스트 부족 → General OCR(Track B) 폴백

결과는 raw_ocr_text 또는 템플릿 필드 형태로 저장(디버깅/재처리)

8) LLM 구조화(필수: OpenRouter로 호출)

OpenRouter로 google/gemini-2.5-flash 호출 
OpenRouter

요청은 OpenRouter Chat Completions 형식으로 보내고, 헤더는 최소:

Authorization: Bearer <OPENROUTER_API_KEY> 
OpenRouter

Content-Type: application/json 
OpenRouter

(선택) HTTP-Referer, X-Title 
OpenRouter
+1

응답은 Structured Outputs로 JSON Schema 강제:

response_format: { type: "json_schema", json_schema: { name, strict: true, schema: … } } 
OpenRouter

스키마 출력 필드:

bill_type, vendor_name, amount_due, due_date

billing_period_start/end(가능하면)

customer_no, payment_account(있으면)

evidence: { amount_text, due_date_text, vendor_text }

confidence(0~1)

프롬프트 규칙(반드시 포함):

금액 후보 다수면 “납부할 금액/납부금액/당월/이번달” 근처를 amount_due로

“미납/연체/가산금”은 amount_due로 선택 금지

날짜 후보 다수면 “납부기한/납기/까지” 근처를 due_date로

9) 검증/정책(필수)

서버 룰로 confidence 재평가:

amount_due > 0, due_date 유효, vendor_name 비어있으면 하향, 근거 약하면 하향
정책:

confidence >= 0.85 → CONFIRMED(또는 auto_confirmed 플래그)

그 외 → NEEDS_REVIEW
잘못된 자동확정 방지가 최우선.

10) 산출물(반드시)

DB migration + RLS

Storage 업로드/서빙

백그라운드 처리기(전처리→OCR→OpenRouter LLM→검증)

Next.js API route handlers

Mantine 기반 3페이지 UI

재처리(retry) 동작

.env 키 정리:

OPENROUTER_API_KEY, OPENROUTER_SITE_URL(선택), OPENROUTER_APP_NAME(선택)

CLOVA_OCR_SECRET, CLOVA_OCR_ENDPOINTS/TEMPLATE_IDS 등

11) 성공 기준(필수)

업로드 시 스캔본(크롭/원근보정) 생성

템플릿 있는 고지서는 Template OCR로 정확도 높음

템플릿 실패 시 General OCR + LLM으로 최소 필드 채움

애매하면 NEEDS_REVIEW

검수 후 확정 가능

재처리로 다시 분석 가능